name: Deploy Todo API to GCP Swarm

on:
    push:
        branches:
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

            - name: Configure Docker for Artifact Registry
              run: |
                  gcloud auth configure-docker asia-southeast1-docker.pkg.dev --quiet

            - name: Build and Push Docker image
              run: |
                  docker build --provenance=false -t asia-southeast1-docker.pkg.dev/voltarocks-42-sandbox/todo-repo/todo-app:latest .
                  docker push asia-southeast1-docker.pkg.dev/voltarocks-42-sandbox/todo-repo/todo-app:latest

            - name: Deploy to Compute Engine via gcloud
              run: |
                  gcloud compute ssh todo-swarm-manager \
                      --zone=asia-southeast1-a \
                      --project=voltarocks-42-sandbox \
                      --tunnel-through-iap \
                      --command="sudo docker service update --image asia-southeast1-docker.pkg.dev/voltarocks-42-sandbox/todo-repo/todo-app:latest --with-registry-auth --force todo_stack_todo-backend"
